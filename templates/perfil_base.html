{% extends "base.html" %}
{% load staticfiles %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/estilos_foto_perfil.css' %}">
<link href="{% static 'Template/jquery/vendors/bower_components/lightgallery/light-gallery/css/lightGallery.css' %}" rel="stylesheet">
<link href="{% static 'Template/jquery/vendors/bower_components/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet">
{% endblock css %}

{% block js %}
<script src="{% static 'Template/jquery/vendors/bower_components/lightgallery/light-gallery/js/lightGallery.min.js' %}"></script>
<script src="{% static 'Template/jquery/vendors/bower_components/mediaelement/build/mediaelement-and-player.min.js' %}"></script>
<script type="text/javascript">
	$(document).ready(function(){
        $("#id_horaDiscipulado").datetimepicker({
            format: 'HH:mm',
        });
        $("#id_horaGAR").datetimepicker({
            format: 'HH:mm'
        });

        {% if miembro.estadoCivil != 'C' %}
        $("#cpm1").addClass('hidden');
        {% endif %}

        $("#id_estadoCivil").change(function(event) {
            if ($(this).val() == 'C') {
                if ($("#cpm1").hasClass('hidden')) {
                    $("#cpm1").removeClass('hidden')
                }
            } else {
                if (!$("#cpm1").hasClass('hidden')) {
                    $("#id_conyugue").val('');
                    $("#cpm1").addClass('hidden');
                }
            }
        });


        {% if ok %}
        $(window).load(function(e){
            var nFrom = $(this).attr('data-from');
            var nAlign = $(this).attr('data-align');
            var nIcons = $(this).attr('data-icon');
            var nType = $(this).attr('data-type');
            var nAnimIn = $(this).attr('data-animation-in');
            var nAnimOut = $(this).attr('data-animation-out');
            
            notify('{{ms}}', nFrom, nAlign, nIcons, 'success', 'animated bounceIn', nAnimOut);
        });
        {% endif %}
        {% if form.errors %}
        $(window).load(function(e){
            var nFrom = $(this).attr('data-from');
            var nAlign = $(this).attr('data-align');
            var nIcons = $(this).attr('data-icon');
            var nType = $(this).attr('data-type');
            var nAnimIn = $(this).attr('data-animation-in');
            var nAnimOut = $(this).attr('data-animation-out');
            
            notify('{{ms}}', nFrom, nAlign, nIcons, 'danger', 'animated bounceIn', nAnimOut);

            $('.edit-error').click();
        });
        {% endif %}

        var $nombre = $('#id_nombre').val();
        var $papellido = $('#id_primerApellido').val();
        var $sapellido = $('#id_segundoApellido').val();
        var $genero = $('#id_genero').val();
        var $fecha = $('#id_fechaNacimiento').val();
        var $estadoCivil = $('#id_estadoCivil').val();
        var $telefono = $('#id_telefono').val();
        var $celular = $('#id_celular').val();
        var $direccion = $('#id_direccion').val();
        var $email = $('#id_email').val();

		$("#id_fechaNacimiento").datetimepicker({ 
			format: 'DD/MM/YYYY',
            maxDate: moment(),
		});


        $('#change-photo').click(function(event) {
            $('#id_foto_perfil').click();
        });
        
        if(!$('html').hasClass('ismobile')) {
            if($('.loader-fotop')[0]) {
                setTimeout (function () {
                    $('.loader-fotop').fadeOut();
                }, 500);

            }
        }

        // if (window.File && window.FileReader && window.FileList && window.Blob) {
        //     document.getElementById('filesToUpload').onchange = function(){
        //         var files = document.getElementById('filesToUpload').files;
        //         for(var i = 0; i < files.length; i++) {
        //             resizeAndUpload(files[i]);
        //         }
        //     };
        // } else {
        //     alert('The File APIs are not fully supported in this browser.');
        // }
         
        function resizeAndUpload(file) {
            var reader = new FileReader();
                reader.onloadend = function() {
             
                var tempImg = new Image();
                tempImg.src = reader.result;
                tempImg.onload = function() {
             
                    var MAX_WIDTH = 600;
                    var MAX_HEIGHT = 600;
                    var tempW = tempImg.width;
                    var tempH = tempImg.height;
                    if (tempW > tempH) {
                        if (tempW > MAX_WIDTH) {
                           tempH *= MAX_WIDTH / tempW;
                           tempW = MAX_WIDTH;
                        }
                    } else {
                        if (tempH > MAX_HEIGHT) {
                           tempW *= MAX_HEIGHT / tempH;
                           tempH = MAX_HEIGHT;
                        }
                    }
             
                    var canvas = document.createElement('canvas');
                    canvas.width = tempW;
                    canvas.height = tempH;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(this, 0, 0, tempW, tempH);
                    var dataURL = canvas.toDataURL("image/jpeg");
                    console.log(dataURL);
                    return dataURL;
                    // var xhr = new XMLHttpRequest();
                    // xhr.onreadystatechange = function(ev){
                    //     document.getElementById('filesInfo').innerHTML = 'Done!';
                    // };
             
                    // xhr.open('POST', 'uploadResized.php', true);
                    // xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                    // var data = 'image=' + dataURL;
                    // xhr.send(data);
                  }
             
               }
            reader.readAsDataURL(file);
        }

        $("#id_foto_perfil").change(function(event) {
            formdata = new FormData();
            var nFrom = $(this).attr('data-from');
            var nAlign = $(this).attr('data-align');
            var nIcons = $(this).attr('data-icon');
            var nType = $(this).attr('data-type');
            var nAnimIn = $(this).attr('data-animation-in');
            var nAnimOut = $(this).attr('data-animation-out');
            var file = this.files[0];
            var $csrf = $('input[name="csrfmiddlewaretoken"]').val()

            if (formdata) {
                // console.log(file);
                // console.log($('input[type="file"]')[0]);
                // 2000000
                if (file.size > 20) {
                    notify("Se esta controlando el tamaño de la imagen", nFrom, nAlign, nIcons, "info", 'animated bounceIn', nAnimOut);
                    imgre = resizeAndUpload($('input[type="file"]')[0].files);
                    console.log(imgre);
                } else {
                    formdata.append('foto_perfil', file);
                    formdata.append('csrfmiddlewaretoken', $csrf);
                    formdata.append('file', '')

                    $.ajax({
                        url: '/miembro/perfil/',
                        type: 'POST',
                        data: formdata,
                        processData: false,
                        contentType: false,
                        beforeSend: function(){
                            if ($('.loader-fotop')[0]) {
                                $('.loader-fotop').fadeIn();
                            }
                        },
                        success: function(data){
                            $('#photo-p').attr('src', function() {
                                return data.ruta;
                            })
                            $('.loader-fotop').fadeOut();
                            notify(data.ms, nFrom, nAlign, nIcons, data.status, 'animated bounceIn', nAnimOut);
                        }
                    })
                }
            }
        });

        $('#delete-photo').click(function(event) {
            var csrf = $('input[name="csrfmiddlewaretoken"]').val()
            $.ajax({
                url: '/miembro/eliminar_foto_perfil/{{miembro.id}}',
                type: 'POST',
                data: {'delete_file': '', 'csrfmiddlewaretoken': csrf},
                success: function(data){
                    $('#photo-p').attr('src', function() {
                        return data.ruta;
                    })
                    var nFrom = $(this).attr('data-from');
                    var nAlign = $(this).attr('data-align');
                    var nIcons = $(this).attr('data-icon');
                    var nType = $(this).attr('data-type');
                    var nAnimIn = $(this).attr('data-animation-in');
                    var nAnimOut = $(this).attr('data-animation-out');
                    
                    notify(data.ms, nFrom, nAlign, nIcons, data.status, 'animated bounceIn', nAnimOut);
                }
            })
        });
    });
</script>
{% block js2 %}
{% endblock js2 %}
{% endblock %}

{% block contenido %}
    
        <div class="container">
            <div class="block-header">
                <h2>{{miembro.nombre|upper}} {{miembro.primerApellido|upper}}<small>{% if miembro.grupoLidera %}Lider del grupo '{{miembro.grupoLidera.nombre|upper}}'{% else %}{% if miembro.grupo %}Pertenece al grupo '{{miembro.grupo.nombre|upper}}'{% else %}No Pertenece a Grupo Aún{% endif %}{% endif %}</small></h2>
                {% if perms.miembros.es_administrador %}
                <ul class="actions m-t-20 hidden-xs">
                    <li class="dropdown">
                        <a href="" data-toggle="dropdown">
                            <i class="zmdi zmdi-more-vert"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            {% if not miembro.asisteGAR and not miembro.grupo %}
                            <li>
                                <a href="/miembro/asignar_grupo/{{miembro.id}}/">Asignar a Grupo</a>
                            </li>
                            {% endif %}
                            {% if not miembro.usuario %}
                            <li>
                                <a href="/miembro/asignar_usuario/{{miembro.id}}/">Asignar Usuario</a>
                            </li>
                            {% endif %}
                            <!-- <li>
                                <a href="/miembro/cambiar_tipo_miembro/{{miembro.id}}/">Agregar Tipo de Miembro</a>
                            </li> -->
                            <li>
                                <a href="">Refrescar</a>
                            </li>
                        </ul>
                    </li>
                </ul>
                {% endif %}
            </div>
            
            <div class="card" id="profile-main">
                <div class="pm-overview c-overflow">
                    <div class="pmo-pic">
                        <div class="p-relative">
                            {% if mismo %}
                            <input type="file" name="foto_perfil" id="id_foto_perfil" accept="image/*">
                            {% endif %}
                            <img id="photo-p" class="img-responsive" src="{% if miembro.foto_perfil %}{{ miembro.foto_perfil.url }}{% else %}{% static 'Imagenes/profile-none.jpg' %}{% endif%}" alt=""> 
                            
                            <!-- <div class="dropdown pmop-message">
                                <a data-toggle="dropdown" href="" class="btn bgm-white btn-float z-depth-1">
                                    <i class="zmdi zmdi-comment-text-alt"></i>
                                </a>
                                
                                <div class="dropdown-menu">
                                    <textarea placeholder="Write something..."></textarea>
                                    
                                    <button class="btn bgm-green btn-float"><i class="zmdi zmdi-mail-send"></i></button>
                                </div>
                            </div> -->
                            
                            {% if mismo %}
                            <a class="pmop-edit" id="change-photo" style="width:50%; cursor:pointer;">
                                <i class="zmdi zmdi-camera"></i> <span class="hidden-xs">Cambiar Foto de Perfil</span>
                            </a>
                            <a  class="pmop-edit" id="delete-photo" style="width:50%; margin-left:50%; cursor:pointer;">
                                <i class="zmdi zmdi-delete"></i> <span class="hidden-xs">Eliminar Foto de Perfil</span>
                            </a>
                            {% else %}
                                {% if perms.miembro.es_administrador %}
                                <a href="#" class="pmop-edit" id="delete-photo">
                                    <i class="zmdi zmdi-delete"></i> <span class="hidden-xs">Eliminar foto de perfil</span>
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="preloader pl-xxl loader-fotop" style="">
                            <svg class="pl-circular" viewBox="25 25 50 50">
                                <circle class="plc-path" cx="50" cy="50" r="20" />
                            </svg>
                        </div>
                        
                        
                        <div class="pmo-stat {% if miembro.genero == 'F' %} bgm-pink{% else %} bgm-cyan{% endif %}">
                            <h2 class="m-0 c-white">{{miembro.nombre|upper}}</h2>
                             {{miembro.cedula}}
                        </div>
                    </div>
                    
                    <div class="pmo-block pmo-contact hidden-xs">
                        <h2>Contacto</h2>
                        
                        <ul>
                            <li><i class="zmdi zmdi-phone"></i> {% if miembro.celular %}{{miembro.celular}}{% else %}SIN DATOS{% endif %}</li>
                            <li><i class="zmdi zmdi-email"></i> {% if miembro.email %}{{miembro.email}}{% else %}SIN DATOS{% endif %}</li>
                            <li><i class="zmdi zmdi-pin"></i> {% if miembro.direccion %}{{miembro.direccion|upper}}{% else %}SIN DATOS{% endif %}</li>
                            <li><i class="zmdi zmdi-facebook-box"></i> Proximamente...</li>
                            <li><i class="zmdi zmdi-twitter"></i> Proximamente...</li>
                        </ul>
                    </div>
                </div>
                <div class="pm-body clearfix">
                    <ul class="tab-nav tn-justified">
                        <li class="{% if p %}active{% endif %} waves-effect"><a href="{% if pk %}/miembro/perfil/{{pk}}{% else %}/miembro/perfil/{% endif %}">Información de Miembro</a></li>
                        <li class="{% if g %}active{% endif %} waves-effect"><a href="{% if pk %}/miembro/grupo/{{pk}}{% else %}/miembro/grupo/{% endif %}">Grupo</a></li>
                        {% if miembro.discipulos %}
                        <li class="{% if d %}active{% endif %} waves-effect"><a href="{% if pk %}/miembro/discipulos/{{pk}}{% else %}/miembro/discipulos/{% endif %}">Discípulos</a></li>
                        {% endif %}
                        <li class="{% if i %}active{% endif %} waves-effect"><a href="/miembro/informacion_iglesia/{% if pk %}{{pk}}{% endif %}">Información de la Iglesia</a></li>
                    </ul>
                {% block card %}
                    
                {% endblock card %}
                </div>
            </div>
        </div>

    </section>
</section>
{% endblock contenido %}